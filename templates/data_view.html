<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT 数据查看</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .json-data {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .device-badge {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">IoT 数据查看</h1>
        
        <!-- 筛选表单 -->
        <div class="filter-section">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="device_id" class="form-label">设备ID</label>
                    <select class="form-select" id="device_id" name="device_id">
                        <option value="">全部设备</option>
                        {% for device in devices %}
                        <option value="{{ device }}" {% if device == current_device %}selected{% endif %}>{{ device }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="start_time" class="form-label">开始时间</label>
                    <input type="datetime-local" class="form-control" id="start_time" name="start_time" value="{{ start_time }}">
                </div>
                <div class="col-md-3">
                    <label for="end_time" class="form-label">结束时间</label>
                    <input type="datetime-local" class="form-control" id="end_time" name="end_time" value="{{ end_time }}">
                </div>
                <div class="col-md-2">
                    <label for="limit" class="form-label">显示条数</label>
                    <input type="number" class="form-control" id="limit" name="limit" min="1" value="{{ limit }}">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">筛选</button>
                    <a href="/" class="btn btn-outline-secondary ms-2">重置</a>
                </div>
            </form>
        </div>
        
        <!-- 设备快捷筛选 -->
        <div class="mb-3">
            <span class="me-2">快速筛选:</span>
            {% for device in devices %}
            <span class="badge bg-secondary device-badge me-1" onclick="filterDevice('{{ device }}')">{{ device }}</span>
            {% endfor %}
        </div>
        
        <!-- 数据表格 -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>设备ID</th>
                        <th>时间戳</th>
                        <th>数据</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    <tr>
                        <td>{{ item.id }}</td>
                        <td>{{ item.device_id }}</td>
                        <td>{{ item.timestamp }}</td>
                        <td>
                            <div class="json-data">
                                <pre>{{ item.data | tojson(indent=2) }}</pre>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center">没有找到数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 数据统计 -->
        <div class="mt-3 text-muted">
            共显示 {{ data | length }} 条记录
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function filterDevice(deviceId) {
            document.getElementById('device_id').value = deviceId;
            document.querySelector('form').submit();
        }
        
        // 自动填充时间格式
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const timeInputs = document.querySelectorAll('input[type="datetime-local"]');
            
            // 如果没有值，设置默认时间范围（最近24小时）
            if (!timeInputs[0].value && !timeInputs[1].value) {
                const endTime = new Date();
                const startTime = new Date();
                startTime.setDate(startTime.getDate() - 1);
                
                timeInputs[0].value = formatDateTimeLocal(startTime);
                timeInputs[1].value = formatDateTimeLocal(endTime);
            }
        });
        
        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }
    </script>
</body>
</html>
